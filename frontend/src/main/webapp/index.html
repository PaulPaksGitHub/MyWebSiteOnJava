<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Hello World</title>

	<script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>

	<script crossorigin src="https://unpkg.com/react@16/umd/react.production.min.js"></script>
	<script crossorigin src="https://unpkg.com/react-dom@16/umd/react-dom.production.min.js"></script>
</head>
<body>

<div id="form"></div>
<div id="users"></div>
<div id="login-form"></div>

<script type="text/babel">

function handleClick(props) {
	console.log('---','clicked')
	this.setState({
		isOpen: !this.state.isOpen
	})
	const {userid} = props
	console.log('---',{userid})
}

class UserClick extends React.Component {
	constructor(props) {
		super(props);
		this.state = {
			tableOpen: false
		};
		this.clicked = this.clicked.bind(this)
	}
	clicked() {
		console.log('---','clicked')
		this.setState({tableOpen : !this.state.tableOpen });
	}
	render() {
		const {userid} = this.props
		if (this.state.tableOpen === true){
			return (
			<div>
				<button onClick={this.clicked}>Close</button>
				<AutorityTable userid={userid}/>
			</div>
			);
		} else {
			return <button onClick={this.clicked}>Select {userid}</button>
		}
	}
}

class AutorClick extends React.Component {
	constructor(props) {
		super(props);
		this.state = {
			tableOpen: false
		};
		this.clicked = this.clicked.bind(this)
	}
	clicked() {
		console.log('---','clicked')
		this.setState({tableOpen : !this.state.tableOpen });
	}
	render() {
		const {autorityid} = this.props
		if (this.state.tableOpen === true){
			return (
			<div>
				<button onClick={this.clicked}>Close</button>
				<ActivityTable autorityid={autorityid}/>
			</div>
			);
		} else {
			return <button onClick={this.clicked}>Select {autorityid}</button>
		}
	}
}

class UserTable extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      error: null,
      isLoaded: false,
      items: [],
	  isOpen: true
    };

	this.handleClick = handleClick.bind(this)
  }

  componentDidMount() {
    fetch("ajax/user")
      .then(res => res.json())
      .then(
        (result) => {
          this.setState({
            isLoaded: true,
            items: result.items
          });
        },
        (error) => {
          this.setState({
            isLoaded: false,
            error
          });
        }
      )
  }

  render() {
    const { error, isLoaded, items } = this.state;
	console.log('items',items)
    if (error) {
      return <div>Error: {error.message}</div>;
    } else if (this.state.isOpen === true) {
		return (
        <table className="table" >
        	<thead>
            <tr>
              <th>id</th>
            	<th>login</th>
              <th>version</th>
            </tr>
        	</thead>
        <tbody>
            {items.map(item => {
                return (
                    <tr key={item.id}>
                      <td>{item.id}</td>
                      <td>{item.login}</td>
                      <td>{item.version}</td>
											<UserClick userid={item.id}/>
                    </tr>
                    );
                })
            }
        </tbody>
    </table>
      );
	}
    else {
      return (
        <div/>
      );
    }
  }
}

class AutorityTable extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      error: null,
      isLoaded: false,
      items: [],
	  isOpen: true,
    };

	this.handleClick = handleClick.bind(this)
  }

  componentDidMount() {
	const {userid} = this.props
    fetch("ajax/authority?userid="+userid)
      .then(res => res.json())
      .then(
        (result) => {
          this.setState({
            isLoaded: true,
            items: result.items
          });
        },
        (error) => {
          this.setState({
            isLoaded: false,
            error
          });
        }
      )
  }

  render() {
    const { error, isLoaded, items } = this.state;
    if (error) {
      return <div>Error: {error.message}</div>;
    } else if (this.state.isOpen === true) {
		return (
      <table className="table" >
			<thead>
				<tr>
					<th>id</th>
          <th>version</th>
					<th>adress</th>
					<th>role</th>
        </tr>
			</thead>
        <tbody>
            {items.map(item => {
                return (
                    <tr key={item.id}>
                      <td>{item.id}</td>
                      <td>{item.version}</td>
											<td>{item.adress}</td>
											<td>{item.role}</td>
											<AutorClick autorityid={item.role}/>
                    </tr>
                    );
                })
            }
        </tbody>
    </table>
      );
	}
    else {
      return (
        <div/>
      );
    }
  }
}

class ActivityTable extends React.Component {
  constructor(props) {
    super(props);
    this.state = {
      error: null,
      isLoaded: false,
      items: [],
	  isOpen: true,
	  autorityid: 'READ'
    };

	this.handleClick = handleClick.bind(this)
  }

  componentDidMount() {
	const {autorityid} = this.props
    fetch("ajax/activity?autorityid="+autorityid)
      .then(res => res.json())
      .then(
        (result) => {
          this.setState({
            isLoaded: true,
            items: result.items
          });
        },
        (error) => {
          this.setState({
            isLoaded: false,
            error
          });
        }
      )
  }

  render() {
    const { error, isLoaded, items } = this.state;
    if (error) {
      return <div>Error: {error.message}</div>;
    } else if (this.state.isOpen === true) {
		return (
      <table className="table" >
			<thead>
				<tr>
					<th>id</th>
          <th>version</th>
          <th>ds</th>
					<th>de</th>
					<th>vol</th>
        </tr>
        </thead>
        <tbody>
            {items.map(item => {
                return (
                    <tr key={item.id}>
                        <td>{item.id}</td>
                        <td>{item.version}</td>
                        <td>{item.ds}</td>
                        <td>{item.de}</td>
                        <td>{item.vol}</td>
                    </tr>
                    );
                })
            }
        </tbody>
    </table>
      );
	}
    else {
      return (
        <div/>
      );
    }
  }
}

class Main extends React.Component {
	render() {
		return (
		<div>
			<UserTable />
		</div>
		);
	}
}

ReactDOM.render(
	<Main />, document.getElementById('users')
);

class Form extends React.Component {
	constructor(props) {
    super(props);
		this.state = {
			items: [],
			login: '',
			pass: '',
			res: '',
			role: '',
			ds: '',
			de: '',
			vol: ''
		};
		this.handleSubmit = this.handleSubmit.bind(this);
		this.handleLoginChange = this.handleLoginChange.bind(this);
		this.handlePassChange = this.handlePassChange.bind(this);
		this.handleResChange = this.handleResChange.bind(this);
		this.handleRoleChange = this.handleRoleChange.bind(this);
		this.handleDsChange = this.handleDsChange.bind(this);
		this.handleDeChange = this.handleDeChange.bind(this);
		this.handleVolChange = this.handleVolChange.bind(this);
	}

	handleSubmit (event){
		event.preventDefault();

		fetch('ajax/activity', {
		    method: 'post',
				credentials: 'include',
				headers:
            {'Content-Type': 'application/x-www-form-urlencoded'}
          ,
		    body: JSON.stringify({
					login: this.state.login,
					pass: this.state.pass,
					res: this.state.res,
					role: this.state.role,
					ds: this.state.ds,
					de: this.state.de,
					vol: this.state.vol
				})

		  }).then(res => res.json())
      .then(
        (result) => {
          this.setState({
            items: result.items
          });
					console.log(result.items);
        },
        (error) => {
          console.log(error);
        }
      )
	}

	handleLoginChange (event){
		this.setState({login: event.target.value});
	}
	handlePassChange (event){
		this.setState({pass: event.target.value});
	}
	handleResChange (event){
		this.setState({res: event.target.value});
	}
	handleRoleChange (event){
		this.setState({role: event.target.value});
	}
	handleDsChange (event){
		this.setState({ds: event.target.value});
	}
	handleDeChange (event){
		this.setState({de: event.target.value});
	}
	handleVolChange (event){
		this.setState({vol: event.target.value});
	}

	render () {
		return (
			<form onSubmit={this.handleSubmit}>
				<input
					id="1"
					name="login"
					type="text"
					placeholder="Login"
					value={this.state.login}
					onChange={this.handleLoginChange}
				/><br />
				<input
					id="2"
					name="pass"
					type="text"
					placeholder="Password"
					value={this.state.pass}
					onChange={this.handlePassChange}
				/><br />
				<input
					id="3"
					name="res"
					type="text"
					placeholder="Resource"
					value={this.state.res}
					onChange={this.handleResChange}
				/><br />
				<input
					id="4"
					name="role"
					type="text"
					placeholder="Role"
					value={this.state.role}
					onChange={this.handleRoleChange}
				/><br />
				<input
					id="5"
					name="ds"
					type="text"
					placeholder="Date of start"
					value={this.state.ds}
					onChange={this.handleDsChange}
				/><br />
				<input
					id="6"
					name="de"
					type="text"
					placeholder="Date of end"
					value={this.state.de}
					onChange={this.handleDeChange}
				/><br />
				<input
					id="7"
					name="vol"
					type="text"
					placeholder="Volume"
					value={this.state.vol}
					onChange={this.handleVolChange}
				/><br />
				<button>Submit</button>
			</form>
		);
	}
}

ReactDOM.render(
	<Form />, document.getElementById('login-form')
);
</script>

</body>
</html>
